package com.apollographql.apollo.compiler.codegen.kotlin

import com.apollographql.apollo.compiler.PackageNameProvider
import com.apollographql.apollo.compiler.ast.*
import com.squareup.kotlinpoet.FileSpec
import com.squareup.kotlinpoet.TypeSpec
import java.io.File

internal class SchemaCodegen(
    private val packageNameProvider: PackageNameProvider,
    private val generateAsInternal: Boolean = false
) : SchemaVisitor {
  private var fileSpecs: List<FileSpec> = emptyList()

  override fun visit(customTypes: CustomTypes) {
    fileSpecs = fileSpecs + customTypes.typeSpec(generateAsInternal).fileSpec(packageNameProvider.typesPackageName)
  }

  override fun visit(enumType: EnumType) {
    fileSpecs = fileSpecs + enumType.typeSpec(generateAsInternal).fileSpec(packageNameProvider.typesPackageName)
  }

  override fun visit(inputType: InputType) {
    fileSpecs = fileSpecs + inputType.typeSpec(generateAsInternal).fileSpec(packageNameProvider.typesPackageName)
  }

  override fun visit(fragmentType: ObjectType) {
    fileSpecs = fileSpecs + fragmentType.typeSpec(generateAsInternal).fileSpec(packageNameProvider.fragmentsPackageName)
  }

  override fun visit(operationType: OperationType) {
    val targetPackage = packageNameProvider.operationPackageName(operationType.filePath)
    fileSpecs = fileSpecs + operationType.typeSpec(targetPackage = targetPackage, generateAsInternal = generateAsInternal)
        .fileSpec(targetPackage)
  }

  fun writeTo(outputDir: File) {
    fileSpecs.forEach { it.writeTo(outputDir) }
  }

  private fun TypeSpec.fileSpec(packageName: String) =
      FileSpec
          .builder(packageName, name!!)
          .addType(this)
          .addComment("AUTO-GENERATED FILE. DO NOT MODIFY.\n\n" +
              "This class was automatically generated by Apollo GraphQL plugin from the GraphQL queries it found.\n" +
              "It should not be modified by hand.\n"
          )
          .build()
}
