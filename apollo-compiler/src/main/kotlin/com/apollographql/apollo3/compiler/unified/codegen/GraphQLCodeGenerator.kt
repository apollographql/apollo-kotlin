package com.apollographql.apollo3.compiler.unified.codegen

import com.apollographql.apollo3.compiler.VERSION
import com.apollographql.apollo3.compiler.unified.IntermediateRepresentation
import com.squareup.kotlinpoet.FileSpec
import com.squareup.kotlinpoet.KModifier
import com.squareup.kotlinpoet.TypeSpec
import java.io.File

/**
 * KotlinPoet [FileSpec] are non qualified. This is a simple wrapper that carries a package name so that we can write the file
 *
 * If multiple [TypeSpec] are in the same [packageName], [fileName] is mandatory
 */
class ApolloFileSpec(
    val packageName: String,
    val typeSpec: List<TypeSpec>,
    val fileName: String,
) {
  constructor(packageName: String, typeSpec: TypeSpec): this(packageName, listOf(typeSpec), typeSpec.name!!)
}

class GraphQLCodeGenerator(
    private val ir: IntermediateRepresentation,
    private val generateAsInternal: Boolean = false,
    private val enumAsSealedClassPatternFilters: List<Regex>,
    private val generateScalarMapping: Boolean,
) {
  fun write(outputDir: File) {
    val customScalars = if (generateScalarMapping) {
      listOf(ir.customScalars.qualifiedTypeSpec())
    } else {
      emptyList()
    }

    val enums = ir.enums.flatMap { enum ->
      enum.qualifiedTypeSpecs(enumAsSealedClassPatternFilters = enumAsSealedClassPatternFilters)
    }

    val inputObjects = ir.inputObjects.flatMap { inputObject ->
      inputObject.qualifiedTypeSpecs()
    }

    val operations = ir.operations.flatMap { operation ->
      operation.qualifiedTypeSpecs()
    }

    val fragments = ir.fragments.flatMap { fragment ->
      fragment.qualifiedTypeSpecs()
    }

    val qualifiedTypeSpecs = customScalars + enums + inputObjects + operations + fragments

    // sanity check
    qualifiedTypeSpecs.groupBy { it.packageName to it.fileName }.forEach {
      check (it.value.size == 1) {
        "Duplicate type found: ${it.key}"
      }
    }

    qualifiedTypeSpecs.forEach {
      fileSpecBuilder(it.packageName, it.fileName)
          .apply {
            it.typeSpec.forEach {
              addType(it.internal(generateAsInternal))
            }
          }
          .build()
          .writeTo(outputDir)
    }
  }

  private fun fileSpecBuilder(packageName: String, name: String): FileSpec.Builder =
      FileSpec
          .builder(packageName, name)
          .addComment("\nAUTO-GENERATED FILE. DO NOT MODIFY.\n\n" +
              "This class was automatically generated by Apollo GraphQL version '$VERSION'.\n"
          )

  private fun TypeSpec.internal(generateAsInternal: Boolean): TypeSpec {
    return if (generateAsInternal) {
      this.toBuilder().addModifiers(KModifier.INTERNAL).build()
    } else {
      this
    }
  }
}